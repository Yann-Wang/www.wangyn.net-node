<!DOCTYPE HTML><html><head><meta charset=utf-8><title>Node.js中的async模块的内部实现 | Catullus | a Latin poet of the late Roman Republic</title><meta name=author content=Yann-Wang><meta name=description content=写技术，写心情，写日记><meta name=keywords content="async,inner implementing,source code"><meta id=viewport name=viewport content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black><meta property=og:title content=Node.js中的async模块的内部实现><meta property=og:site_name content=Catullus><meta property=og:image content=/favicon.ico><link href=/favicon.ico rel=icon><link rel=alternate href=/atom.xml title=Catullus type=application/atom+xml><link rel=stylesheet href=/css/style.css media=screen type=text/css></head><body><div class=blog><div class=content><header><div class=site-branding><h1 class=site-title><a href="/">Catullus</a></h1><p class=site-description>a Latin poet of the late Roman Republic</p></div><nav class=site-navigation><ul><li><a href="/">Home</a></li><li><a href=/archives>Archives</a></li></ul></nav></header><main class="site-main posts-loop"><article><h3 class=article-title><span>Node.js中的async模块的内部实现</span></h3><div class=article-top-meta><span class=posted-on><a href="/2016/07/03/the-inner-implementing-of-async-module-in-Node-js/" rel=bookmark><time class="entry-date published" datetime=2016-07-03T03:44:51.000Z>2016-07-03</time></a></span></div><div class=article-content><div class=entry><h3 id=Async-js中的-each和-eachSeries><a href=#Async-js中的-each和-eachSeries class=headerlink title=Async.js中的.each和.eachSeries></a>Async.js中的.each和.eachSeries</h3><ul><li>.each 并不是真正的并行，而是.each中的函数有异步回调，.each不能保证每次调用异步回调都是按先后顺序调用的。也就是说，并行的是回调函数（此处的并行，并不是系统层面的并行）。</li><li>.each实现思路：顺序遍历执行数组中的函数，声明一个变量count=0，在每个callback函数中 将count++，然后判断count 是否与数组.length相等，如果等，就调用最后的callback。</li><li>.eachSeries实现思路：在前一个的callback函数中调用后一个函数。</li><li><p>async.series也是根据.eachSeries来实现的。</p></li><li><p><a href=https://github.com/caolan/async/blob/v1.5.2/lib/async.js target=_blank rel=external>Async.js v1.5.2版本</a></p><a id=more></a><h3 id=async-each-和-async-eachSeries-的实现><a href=#async-each-和-async-eachSeries-的实现 class=headerlink title="async.each 和 async.eachSeries 的实现"></a>async.each 和 async.eachSeries 的实现</h3></li></ul><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br></pre></td><td class=code><pre><span class=line><span class=function><span class=keyword>function</span> <span class=title>each</span>(<span class=params>arr, iterator, callback</span>) </span>&#123;</span><br><span class=line>    callback = callback || <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;&#125;;</span><br><span class=line>    <span class=keyword>if</span> (!arr.length) &#123;</span><br><span class=line>        <span class=keyword>return</span> callback();</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>var</span> completed = <span class=number>0</span>;</span><br><span class=line>    arr.forEach(<span class=function><span class=keyword>function</span> (<span class=params>x</span>) </span>&#123;</span><br><span class=line>        iterator(x, <span class=function><span class=keyword>function</span> (<span class=params>err</span>) </span>&#123;</span><br><span class=line>            <span class=keyword>if</span> (err) &#123;</span><br><span class=line>                callback(err);</span><br><span class=line>                callback = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;&#125;;</span><br><span class=line>            &#125;</span><br><span class=line>            <span class=keyword>else</span> &#123;</span><br><span class=line>                completed += <span class=number>1</span>;</span><br><span class=line>                <span class=keyword>if</span> (completed &gt;= arr.length) &#123;</span><br><span class=line>                    callback(<span class=literal>null</span>);</span><br><span class=line>                &#125;</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;);</span><br><span class=line>    &#125;);</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>function</span> <span class=title>eachSeries</span>(<span class=params>arr, iterator, callback</span>) </span>&#123;</span><br><span class=line>    callback = callback || <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;&#125;;</span><br><span class=line>    <span class=keyword>if</span> (!arr.length) &#123;</span><br><span class=line>        <span class=keyword>return</span> callback();</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>var</span> completed = <span class=number>0</span>;</span><br><span class=line>    <span class=keyword>var</span> iterate = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;</span><br><span class=line>        iterator(arr[completed], <span class=function><span class=keyword>function</span> (<span class=params>err</span>) </span>&#123;</span><br><span class=line>            <span class=keyword>if</span> (err) &#123;</span><br><span class=line>                callback(err);</span><br><span class=line>                callback = <span class=function><span class=keyword>function</span> (<span class=params></span>) </span>&#123;&#125;;</span><br><span class=line>            &#125;</span><br><span class=line>            <span class=keyword>else</span> &#123;</span><br><span class=line>                completed += <span class=number>1</span>;</span><br><span class=line>                <span class=keyword>if</span> (completed &gt;= arr.length) &#123;</span><br><span class=line>                    callback(<span class=literal>null</span>);</span><br><span class=line>                &#125;</span><br><span class=line>                <span class=keyword>else</span> &#123;</span><br><span class=line>                    iterate();</span><br><span class=line>                &#125;</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;);</span><br><span class=line>    &#125;;</span><br><span class=line>    iterate();</span><br><span class=line></span><br><span class=line>&#125;;</span><br></pre></td></tr></table></figure></div></div><div class=article-footer><div class="article-meta pull-left"><span class=post-categories><i class=icon-categories></i> <a href="/categories/technology/">technology</a></span> <span class=post-tags><i class=icon-tags></i> <a href="/tags/async/">async</a><a href="/tags/inner-implementing/">inner implementing</a><a href="/tags/source-code/">source code</a></span></div></div></article><div id=comment><div class=ds-thread data-thread-key="/2016/07/03/the-inner-implementing-of-async-module-in-Node-js/" data-title=Node.js中的async模块的内部实现 data-url="http://www.wangyn.net/2016/07/03/the-inner-implementing-of-async-module-in-Node-js/"></div><script type=text/javascript>
	var duoshuoQuery = {short_name:"Yann-Wang"};
	  (function() {
	    var ds = document.createElement('script');
	    ds.type = 'text/javascript';ds.async = true;
	    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	    ds.charset = 'UTF-8';
	    (document.getElementsByTagName('head')[0] 
	     || document.getElementsByTagName('body')[0]).appendChild(ds);
	  })();
	  </script></div></main><footer class=site-footer><p class=site-info>Proudly powered by <a href="https://hexo.io/" target=_blank>Hexo</a> and Theme by <a href=https://github.com/CodeDaraW/Hacker target=_blank>Hacker</a><br>&copy; 2016 Yann-Wang</p></footer></div></div></body></html>